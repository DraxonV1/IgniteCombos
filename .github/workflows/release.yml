name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "microsoft"

      - name: Make Gradle executable
        run: chmod +x ./gradlew

      - name: Build
        run: ./gradlew clean build

      - name: Extract Minecraft version from tag
        id: mc_version
        run: |
          TAG="${GITHUB_REF_NAME}"
          GAME_VERSION="${TAG##*-}"
          echo "game_version=$GAME_VERSION" >> $GITHUB_OUTPUT

      # -----------------------------
      # GitHub Release (includes sources jar)
      # -----------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: IgniteCombos ${{ github.ref_name }}
          body_path: CHANGELOG.md
          files: build/libs/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------
      # Modrinth + CurseForge Publish (main jar only)
      # -----------------------------
      - name: Publish to Modrinth & CurseForge
        uses: Kir-Antipov/mc-publish@v3
        with:
          files: build/libs/!(*-@(dev|sources|javadoc)).jar
          
          modrinth-id: yourmom
          modrinth-featured: true
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

          curseforge-id: 123456
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}

          name: IgniteCombos ${{ github.ref_name }}
          version: ${{ github.ref_name }}
          version-type: release

          loaders: fabric
          game-versions: ${{ steps.mc_version.outputs.game_version }}

          changelog: |
            Automated release.
            Full changelog:
            https://github.com/DraxonV1/IgniteCombos/releases/tag/${{ github.ref_name }}
